<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Jsonata Playground</title>
    <script src="https://unpkg.com/petite-vue" defer init></script>
    <script src="https://cdn.jsdelivr.net/npm/jsonata/jsonata.min.js"></script>
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->
    <link href="https://cdn.jsdelivr.net/npm/vscode-codicons@0.0.17/dist/codicon.min.css" rel="stylesheet">
    <style>
        body,
        html {
            margin: 0;
            height: 100%;
            overflow: hidden;
        }

        #monaco-input,
        #monaco-expression {
            flex: 1;
        }

        #cont {
            display: flex;
            width: 100%;
        }

        #divider {
            width: 5px;
            background-color: #ccc;
            cursor: ew-resize;
            position: relative;
        }
    </style>
</head>

<body>

    <div v-scope="{ count: 0 }">
        {{ count }}
        <button @click="count++">inc</button>
    </div>
    <script type="module">
        import * as monaco from 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/+esm';

        var conf = {
            language: 'jsonp',
            theme: 'vs-dark',
            // automaticLayout: true
        };
        let monacoInput = monaco.editor.create(document.querySelector('#monaco-input'), {
            ...conf, value:
                `{
    "sample1": "test1",
    "sample2": "test2",
    "sample3": "test3"
}`
        });
        let monacoExpression = monaco.editor.create(document.querySelector('#monaco-expression'), {
            ...conf, value:
                `sample1`
        });
        let monacoResult = monaco.editor.create(document.querySelector('#monaco-result'), {
            ...conf,
            value: "",
            readOnly: true
        });

        window.monacoInput = monacoInput;
        function onEditorChange() {
            const local = false;
            const inputText = monacoInput.getValue();
            let jsonInput = null;
            const expressionText = monacoExpression.getValue();
            if (local) {
                try {
                    jsonInput = JSON.parse(inputText);
                }
                catch (error) {
                    monacoResult.setValue(`Input error:\n${error.message}`);
                }
                if (!jsonInput) {
                    return;
                }
                try {
                    const compiledExpression = jsonata(expressionText);
                    compiledExpression.evaluate(jsonInput, {}, (error, success) => {
                        if (error) {
                            console.log(error);
                            monacoResult.setValue(error);
                            return;
                        } else {
                            monacoResult.setValue(success ?? "");
                        }
                    });
                }
                catch (error) {
                    const errorText = JSON.stringify(error, null, 2);
                    monacoResult.setValue(`Template error:\n${errorText}`);
                }
            }
            else {
                var http = new XMLHttpRequest();
                var url = '/jsonata';
                http.open('POST', url, true);

                //Send the proper header information along with the request
                http.setRequestHeader('Content-type', 'application/json');

                http.onreadystatechange = function () {//Call a function when the state changes.
                    // if (http.readyState == 4 && http.status == 200) {
                    if (http.readyState == 4) {
                        monacoResult.setValue(http.responseText);
                    }
                }
                http.send(JSON.stringify({input: inputText, expression: expressionText}));
            }
        }
        monacoInput.onDidChangeModelContent(onEditorChange)
        monacoExpression.onDidChangeModelContent(onEditorChange)
        onEditorChange();

        //Resize shit
        const divider = document.getElementById('divider');

        let isResizing = false;

        divider.addEventListener('mousedown', function (e) {
            isResizing = true;
        });

        document.addEventListener('mousemove', function (e) {
            if (!isResizing) return;
            const containerOffsetLeft = document.getElementById('cont').offsetLeft;
            const offsetRight = document.getElementById('cont').offsetWidth - (e.clientX - containerOffsetLeft);
            const offsetLeft = e.clientX - containerOffsetLeft;

            const containerWidth = document.getElementById('cont').offsetWidth;
            const leftPercentage = (offsetLeft / containerWidth) * 100;
            const rightPercentage = 100 - leftPercentage;

            document.getElementById('monaco-input').style.width = leftPercentage + '%';
            document.getElementById('monaco-expression').style.width = rightPercentage + '%';
            monacoInput.layout({ width: offsetLeft - 4, height: 400 });
            monacoExpression.layout({ width: offsetRight - 4, height: 400 });
        });

        document.addEventListener('mouseup', function (e) {
            isResizing = false;
        });

    </script>
    <div id="cont">
        <div id="monaco-input" style="min-height: 400px;border: 1px solid black"></div>
        <div id="divider"></div>
        <div id="monaco-expression" style="min-height: 400px;border: 1px solid black"></div>
    </div>
    <div id="monaco-result" style="min-height: 400px;border: 1px solid black"></div>
</body>

</html>