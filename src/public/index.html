<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Jsonata Playground</title>
    <script src="https://cdn.jsdelivr.net/npm/jsonata/jsonata.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vscode-codicons@0.0.17/dist/codicon.min.css" rel="stylesheet">
    <style>
        body,
        html {
            margin: 0;
            height: 100%;
            overflow: hidden;
        }

        #monaco-input,
        #monaco-expression {
            flex: 1;
        }

        #cont {
            display: flex;
            width: 100%;
        }

        #divider {
            width: 5px;
            background-color: #ccc;
            cursor: ew-resize;
            position: relative;
        }
    </style>
</head>

<body>
    <div v-scope
    @vue:mounted="initializeEditors()">
        <div>
            {{ count }}
            <button @click="count++">inc</button>
        </div>
        <div id="cont">
            <div id="monaco-input" style="min-height: 400px;border: 1px solid black"></div>
            <div id="divider"></div>
            <div id="monaco-expression" style="min-height: 400px;border: 1px solid black"></div>
        </div>
        <div id="monaco-result" style="min-height: 400px;border: 1px solid black"></div>
    </div>

    <script type="module">
        import * as monaco from 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/+esm';
        import { createApp } from 'https://unpkg.com/petite-vue?module';

        function onEditorChange2(e, obj) {
            console.log(e);
            // const inputText = obj.monacoInput.getValue();
            // console.log(inputText);
        }

        createApp({
            count: 1,
            local: false,
            initializeEditors() {
                const conf = {
                    language: 'javascript',
                    theme: 'vs-dark'
                };
                document.monacoInput = monaco.editor.create(document.querySelector('#monaco-input'), {
                    ...conf,
                    value: `{
    "sample1": "test1",
    "sample2": "test2",
    "sample3": "test3"
}`
                });
                document.monacoExpression = monaco.editor.create(document.querySelector('#monaco-expression'), {
                    ...conf,
                    value: `sample1`
                });
                document.monacoResult = monaco.editor.create(document.querySelector('#monaco-result'), {
                    ...conf,
                    value: "",
                    readOnly: true
                });
                document.monacoInput.onDidChangeModelContent(this.onEditorChange.bind(this));
                document.monacoExpression.onDidChangeModelContent(this.onEditorChange.bind(this));
                this.onEditorChange();
            },
            async onEditorChange() {
                const inputText = document.monacoInput.getValue();
                const expressionText = document.monacoExpression.getValue();
                if (this.local) {
                    try {
                        const jsonInput = JSON.parse(inputText);
                        const compiledExpression = jsonata(expressionText);
                        const result = await compiledExpression.evaluate(jsonInput);
                        document.monacoResult.setValue(JSON.stringify(result, null, 2));
                    } catch (error) {
                        document.monacoResult.setValue(`Error:\n${error.message}`);
                    }
                } else {
                    try {
                        const response = await fetch('/jsonata', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                input: inputText,
                                expression: expressionText,
                                csvOutput: true
                            })
                        });
                        const data = await response.text();
                        document.monacoResult.setValue(data);
                    } catch (error) {
                        document.monacoResult.setValue(`Error:\n${error.message}`);
                    }
                }
            },
            onMouseDown(e) {
                this.isResizing = true;
            },
            onMouseMove(e) {
                if (!this.isResizing) return;
                const containerOffsetLeft = document.getElementById('cont').offsetLeft;
                const offsetRight = document.getElementById('cont').offsetWidth - (e.clientX - containerOffsetLeft);
                const offsetLeft = e.clientX - containerOffsetLeft;

                const containerWidth = document.getElementById('cont').offsetWidth;
                const leftPercentage = (offsetLeft / containerWidth) * 100;
                const rightPercentage = 100 - leftPercentage;

                document.getElementById('monaco-input').style.width = leftPercentage + '%';
                document.getElementById('monaco-expression').style.width = rightPercentage + '%';
                this.monacoInput.layout({ width: offsetLeft - 4, height: 400 });
                this.monacoExpression.layout({ width: offsetRight - 4, height: 400 });
            },
            onMouseUp(e) {
                this.isResizing = false;
            },
            isResizing: false,
            mounted() {
                initializeEditors();
            }
        }).mount();

    </script>
</body>

</html>