<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Jsonata Playground</title>
    <link href="https://cdn.jsdelivr.net/npm/vscode-codicons@0.0.17/dist/codicon.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.red.min.css" />
    <style>
        body,
        html {
            margin: 0;
            height: 100%;
            overflow: hidden;
        }

        #monaco-input,
        #monaco-expression {
            flex: 1;
        }

        #cont {
            display: flex;
            width: 100%;
        }

        #divider {
            width: 5px;
            background-color: #ccc;
            cursor: ew-resize;
            position: relative;
        }

        select {
            width: auto;
        }
    </style>
</head>

<body>
    <div id="app" @vue:mounted="initializeEditors()">
        <fieldset class="grid">
            <label>
                CSV Input Mode
                <input v-model="csvInputMode" type="checkbox" role="switch" />
            </label>
            <label v-show="csvInputMode">
                Input Delimiter
                <select v-model="csvInputDelimiter" :disabled="!csvInputMode">
                    <option value=";">;</option>
                    <option value=",">,</option>
                    <option value="\t">\t</option>
                </select>
            </label>
            <label>
                CSV Output Mode
                <input v-model="csvOutputMode" type="checkbox" role="switch" />
            </label>
            <label v-show="csvOutputMode">
                Output Delimiter
                <select v-model="csvOutputDelimiter">
                    <option value=";">;</option>
                    <option value=",">,</option>
                    <option value="\t">\t</option>
                </select>
            </label>
            <label>
                Auto-Refresh
                <input v-model="autoRefresh" type="checkbox" role="switch" />
            </label>
            <label>
                <button @click="compute">Process</button>
            </label>
            <span v-show="processing" aria-busy="true"></span>
        </fieldset>

    <div id="cont">
        <div id="monaco-input" style="min-height: 400px;border: 1px solid black"></div>
        <div id="divider" @mousedown="onMouseDown" @mouseup="onMouseUp"></div>
        <div id="monaco-expression" style="min-height: 400px;border: 1px solid black"></div>
    </div>
    <div id="monaco-result" style="min-height: 400px;border: 1px solid black"></div>
    </div>

    <script type="module">
        import * as monaco from 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/+esm';
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';

        createApp({
            data() {
                return {
                    csvOutputMode: false,
                    csvInputMode: false,
                    isResizing: false,
                    autoRefresh: true,
                    csvInputDelimiter: ',',
                    csvOutputDelimiter: ',',
                    initialized: false,
                    processing: false
                }
            },
            watch: {
                csvOutputMode() {
                    this.saveConfigurationToLocalStorage();
                    this.onEditorChange();
                },
                csvInputMode() {
                    this.saveConfigurationToLocalStorage();
                    this.onEditorChange();
                },
                csvInputDelimiter() {
                    this.saveConfigurationToLocalStorage();
                    this.onEditorChange();
                },
                csvOutputDelimiter() {
                    this.saveConfigurationToLocalStorage();
                    this.onEditorChange();
                },
                autoRefresh(){
                    this.saveConfigurationToLocalStorage();
                }
            },
            mounted() {
                let config = localStorage.getItem("config");
                if (config) {
                    config = JSON.parse(config);
                    this.autoRefresh = config.autoRefresh;
                    this.csvOutputMode = config.csvOutputMode;
                    this.csvInputMode = config.csvInputMode;
                    this.csvInputDelimiter = config.csvInputDelimiter;
                    this.csvOutputDelimiter = config.csvOutputDelimiter;
                }
                this.initializeEditors();
                this.initialized = true;
            },
            methods: {
                saveConfigurationToLocalStorage() {
                    let configAsString = JSON.stringify({
                        csvOutputMode: this.csvOutputMode,
                        csvInputMode: this.csvInputMode,
                        autoRefresh: this.autoRefresh,
                        csvInputDelimiter: this.csvInputDelimiter,
                        csvOutputDelimiter: this.csvOutputDelimiter
                    })
                    localStorage.setItem("config", configAsString);
                },
                initializeEditors() {
                    const conf = {
                        language: 'javascript',
                        theme: 'vs-dark'
                    };


                    document.monacoInput = monaco.editor.create(document.querySelector('#monaco-input'), {
                        ...conf,
                        value: localStorage.getItem('inputText') ??
                            `[{
    "sample1": "test1",
    "sample2": "test2",
    "sample3": "test3"
},
{
    "sample1": "test4",
    "sample2": "test5",
    "sample3": "test6"
}]`
                        //                             `
                        // sample1,sample2,sample3
                        // test1,tesffffffffffft2,test3
                        // test4,test5,test6
                        // `
                    });
                    document.monacoExpression = monaco.editor.create(document.querySelector('#monaco-expression'), {
                        ...conf,
                        value: localStorage.getItem('expressionText') ?? `$`
                    });
                    document.monacoResult = monaco.editor.create(document.querySelector('#monaco-result'), {
                        ...conf,
                        value: "",
                        readOnly: true
                    });
                    document.monacoInput.onDidChangeModelContent(function() {
                        this.onEditorChange()
                    }.bind(this));
                    document.monacoExpression.onDidChangeModelContent(function() {
                        this.onEditorChange()
                    }.bind(this));
                    window.addEventListener('mousemove', this.onMouseMove)
                },
                onEditorChange() {
                    if (this.autoRefresh && this.initialized) {
                        if (this.timer) {
                            clearTimeout(this.timer);
                        }
                        this.timer = setTimeout(this.compute.bind(this), 800);
                    }
                },
                async compute() {
                    this.processing = true;
                    const inputText = document.monacoInput.getValue();
                    const expressionText = document.monacoExpression.getValue();
                    try{
                        localStorage.setItem("inputText", inputText);
                    }
                    catch(e) {
                        console.error(e)
                    }
                    localStorage.setItem("expressionText", expressionText);

                    try {
                        const response = await fetch('/jsonata', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                input: inputText,
                                expression: expressionText,
                                csvOutput: this.csvOutputMode,
                                csvInput: this.csvInputMode,
                                csvInputDelimiter: this.csvInputDelimiter,
                                csvOutputDelimiter: this.csvOutputDelimiter
                            })
                        });
                        const data = await response.text();
                        document.monacoResult.setValue(data);
                    } catch (error) {
                        document.monacoResult.setValue(`Error:\n${error.message}`);
                    }
                    this.processing = false;
                },
                onMouseDown(e) {
                    this.isResizing = true;
                },
                onMouseMove(e) {
                    if (!this.isResizing) return;
                    const containerOffsetLeft = document.getElementById('cont').offsetLeft;
                    const offsetRight = document.getElementById('cont').offsetWidth - (e.clientX - containerOffsetLeft);
                    const offsetLeft = e.clientX - containerOffsetLeft;

                    const containerWidth = document.getElementById('cont').offsetWidth;
                    const leftPercentage = (offsetLeft / containerWidth) * 100;
                    const rightPercentage = 100 - leftPercentage;

                    document.getElementById('monaco-input').style.width = leftPercentage + '%';
                    document.getElementById('monaco-expression').style.width = rightPercentage + '%';
                    document.monacoInput.layout({ width: offsetLeft - 4, height: 400 });
                    document.monacoExpression.layout({ width: offsetRight - 4, height: 400 });
                },
                onMouseUp(e) {
                    this.isResizing = false;
                },
                mounted() {
                    initializeEditors();
                }
            }
        }).mount('#app');

    </script>
</body>

</html>