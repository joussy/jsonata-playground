<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Jsonata Playground</title>
    <script src="https://unpkg.com/petite-vue" defer init></script>
    <script src="https://cdn.jsdelivr.net/npm/jsonata/jsonata.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/vscode-codicons@0.0.17/dist/codicon.min.css" rel="stylesheet">

</head>

<body>

    <div v-scope="{ count: 0 }">
        {{ count }}
        <button @click="count++">inc</button>
    </div>
    <script type="module">
        import * as monaco from 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/+esm';

        var conf = {
            language: 'jsonp',
            theme: 'vs-dark',
            automaticLayout: true
        };
        let monacoInput = monaco.editor.create(document.querySelector('.monaco-input'), {
            ...conf, value:
                `{
    "sample1": "test1",
    "sample2": "test2",
    "sample3": "test3"
}`
        });
        let monacoExpression = monaco.editor.create(document.querySelector('.monaco-expression'), {
            ...conf, value:
                `sample1`
        });
        let monacoResult = monaco.editor.create(document.querySelector('.monaco-result'), {
            ...conf,
            value: "",
            readOnly: true
        });

        window.monacoInput = monacoInput;
        function onEditorChange() {
            const inputText = monacoInput.getValue();
            let jsonInput = null;
            const expressionText = monacoExpression.getValue();
            try {
                jsonInput = JSON.parse(inputText);
            }
            catch (error) {
                monacoResult.setValue(`Input error:\n${error.message}`);
            }
            if (!jsonInput) {
                return;
            }
            try {
                const compiledExpression = jsonata(expressionText);
                compiledExpression.evaluate(jsonInput, {}, (error, success) => {
                    if (error) {
                        console.log(error);
                        monacoResult.setValue(error);
                        return;
                    } else {
                        monacoResult.setValue(success ?? "");
                    }
                });
            }
            catch (error) {
                const errorText = JSON.stringify(error, null, 2);
                monacoResult.setValue(`Template error:\n${errorText}`);
            }
        }
        monacoInput.onDidChangeModelContent(onEditorChange)
        monacoExpression.onDidChangeModelContent(onEditorChange)
        onEditorChange();
    </script>
    <div>
        <div class="d-inline-block" style="width:49%">
            <div class="monaco-input" style="min-height: 400px;border: 1px solid black"></div>
        </div>
        <div class="w-50 d-inline-block" style="width:50%">
            <div class="monaco-expression" style="min-height: 400px;border: 1px solid black"></div>
        </div>
        <div class="col-md-12">
            <div class="monaco-result" style="min-height: 400px;border: 1px solid black"></div>
        </div>
    </div>
</body>

</html>